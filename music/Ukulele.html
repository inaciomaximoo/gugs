<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Estúdio de Ukulele - Editor e Escalas</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel+Decorative:wght@700&family=Cinzel:wght@400;700&family=Roboto+Mono:wght@400;700&family=Merriweather:ital,wght@0,400;0,700;1,400&display=swap" rel="stylesheet">
    <style>
        /* Estilos base */
        body { font-family: 'Merriweather', serif; background-color: #262626; color: #EAEAEA; margin: 0; padding: 20px; display: flex; flex-direction: column; align-items: center; user-select: none; }
        h1 { font-family: 'Cinzel Decorative', cursive; color: #EAEAEA; font-size: 3.5em; text-align: center; text-shadow: 2px 2px 4px rgba(0,0,0,0.4); margin-bottom: 0; }
        h2 { font-family: 'Cinzel', serif; color: #d4af37; text-align: center; margin-top: 40px; font-size: 2.2em; letter-spacing: 2px; font-weight: 700; }
        .introducao { max-width: 900px; text-align: center; color: #ccc; margin-bottom: 20px; line-height: 1.7; }
        .legenda { display: flex; flex-wrap: wrap; gap: 15px; margin-top: 20px; margin-bottom: 30px; align-items: center; justify-content: center; background-color: rgba(0,0,0,0.2); padding: 10px 20px; border-radius: 10px; border: 1px solid #444; }
        .legenda-item { display: flex; align-items: center; gap: 8px; font-weight: bold; }
        .cor-legenda { width: 20px; height: 20px; border-radius: 50%; box-shadow: 0 2px 4px rgba(0,0,0,0.2); display: flex; justify-content: center; align-items: center; font-size: 0.7em; font-weight: bold; color: #262626;}
        .cor-escala { background-color: #ffcc00; border: 1px solid #b38f00; }
        .cor-tonica { background-color: #2a9d8f; color: #EAEAEA; }
        .cor-outra { background-color: #4a4a4a; border: 1px solid #777; color: #ccc; }
        .cor-sugestao { background-color: yellow; }
        .cor-anterior { background-color: #999; }
        .container { display: flex; flex-wrap: wrap; justify-content: center; gap: 25px; max-width: 1200px; width: 100%;}
        .cartao-principal { background-color: #333; border-radius: 8px; box-shadow: 0 4px 15px rgba(0,0,0,0.4); width: 100%; max-width: 1100px; padding: 20px; border: 1px solid #555; box-sizing: border-box; }

        /*========= VISUALIZAÇÃO DO BRAÇO DO UKULELE =========*/
        .fretboard-container { overflow-x: auto; padding-bottom: 10px; border: 1px solid #1a1a1a; border-radius: 5px; background: linear-gradient(90deg, #8c6e4d, #6b4e2d); }
        .fretboard { display: flex; flex-direction: column; width: fit-content; }
        .string { display: flex; align-items: center; border-bottom: 1px solid #6b4e2d; }
        .string:last-child { border-bottom: none; }
        .fret { box-sizing: border-box; height: 42px; border-right: 2px solid #a88a76; position: relative; cursor: pointer; display: flex; justify-content: center; align-items: center; transition: background-color 0.2s, opacity 0.2s; }
        .fret:hover { background-color: rgba(212, 175, 55, 0.2); }
        .fret:nth-child(1) { width: 40px; background-color: #5a3e1d; border-right: 5px solid #2c1e0e; }
        .fret:nth-child(2) { width: 70px; } .fret:nth-child(3) { width: 67px; } .fret:nth-child(4) { width: 64px; } .fret:nth-child(5) { width: 61px; }
        .fret:nth-child(6) { width: 59px; } .fret:nth-child(7) { width: 57px; } .fret:nth-child(8) { width: 55px; } .fret:nth-child(9) { width: 53px; }
        .fret:nth-child(10) { width: 51px; } .fret:nth-child(11) { width: 50px; } .fret:nth-child(n+12) { width: 48px; }
        
        .fret.fret-selecionado { background-color: rgba(46, 204, 113, 0.4); box-shadow: inset 0 0 10px rgba(46, 204, 113, 0.8); }

        .fret.proxima-nota-sugerida, .fret.escala-completa { background-color: rgba(255, 255, 0, 0.45) !important; box-shadow: inset 0 0 10px rgba(255, 255, 0, 0.8); }
        .fret.nota-anterior-sugerida { background-color: rgba(180, 180, 180, 0.4) !important; box-shadow: inset 0 0 8px rgba(255, 255, 255, 0.4); }
        .fret.desativado { opacity: 0.35; }
        
        .fret-note-name {
            position: absolute; z-index: 3; color: #1a1a1a; font-family: 'Roboto Mono', monospace; font-weight: bold; font-size: 0.9em;
            pointer-events: none; visibility: hidden; background: rgba(255, 255, 255, 0.7); border-radius: 50%;
            width: 22px; height: 22px; display: flex; align-items: center; justify-content: center; transition: transform 0.05s ease-out;
        }
        
        .fret.proxima-nota-sugerida .fret-note-name,
        .fret.escala-completa .fret-note-name,
        .fret.dragging .fret-note-name,
        .fret.nota-anterior-sugerida .fret-note-name { visibility: visible; }

        .fret.dragging { background-color: rgba(46, 204, 113, 0.4) !important; box-shadow: inset 0 0 10px rgba(46, 204, 113, 0.8); }
        .fret.slide-target { background-color: rgba(255, 165, 0, 0.5) !important; }

        .marker-host { position: relative; }
        .fret-marker-container { position: absolute; left: 50%; top: -150%; transform: translateX(-50%); height: 400%; width: 100%; display: flex; align-items: center; justify-content: center; z-index: 0; pointer-events: none; }
        .fret-marker { color: rgba(255, 255, 255, 0.25); text-align: center; }
        .fret-marker.single { font-size: 1.1em; }
        .fret-marker.double { font-size: 0.7em; line-height: 1.4; }
        .fret-marker.double::before, .fret-marker.double::after { content: '●'; display: block; }

        .fret-numbers-container { overflow-x: auto; scrollbar-width: none; -ms-overflow-style: none; } .fret-numbers-container::-webkit-scrollbar { display: none; }
        .fret-numbers { display: flex; width: fit-content; }
        .fret-numbers div { flex-shrink: 0; box-sizing: border-box; text-align: center; color: #d4af37; font-family: 'Cinzel', serif; padding-top: 5px; }
        .fret-numbers div:nth-child(1) { width: 40px; }
        .fret-numbers div:nth-child(2) { width: 70px; } .fret-numbers div:nth-child(3) { width: 67px; } .fret-numbers div:nth-child(4) { width: 64px; } .fret-numbers div:nth-child(5) { width: 61px; }
        .fret-numbers div:nth-child(6) { width: 59px; } .fret-numbers div:nth-child(7) { width: 57px; } .fret-numbers div:nth-child(8) { width: 55px; } .fret-numbers div:nth-child(9) { width: 53px; }
        .fret-numbers div:nth-child(10) { width: 51px; } .fret-numbers div:nth-child(11) { width: 50px; } .fret-numbers div:nth-child(n+12) { width: 48px; }

        #tablatura-texto { width: 100%; height: 120px; background-color: #2a2a2a; border: 1px solid #555; color: #ccc; font-family: 'Roboto Mono', monospace; font-size: 1.1em; padding: 10px; border-radius: 5px; margin-top: 15px; box-sizing: border-box; line-height: 1.5; resize: vertical; white-space: pre; }
        .botoes-container { display: flex; flex-wrap: wrap; gap: 10px; justify-content: center; margin-top: 15px; }
        .btn-editor { background-color: #d4af37; color: #262626; border: none; padding: 10px 15px; border-radius: 5px; font-family: 'Cinzel', serif; font-weight: 700; font-size: 1em; cursor: pointer; box-shadow: 0 2px 5px rgba(0,0,0,0.3); transition: background-color 0.2s ease, box-shadow 0.2s ease, color 0.2s ease; }
        .btn-editor:hover { background-color: #f7d065; box-shadow: 0 4px 8px rgba(0,0,0,0.4); }
        .btn-editor.active-mode { background-color: #c92a2a; color: white; }
        .btn-editor.active-mode:hover { background-color: #e74c3c; }
        .btn-controle { background-color: #555; color: #EAEAEA; }
        .btn-controle:hover { background-color: #777; }
        .btn-remover { background-color: #c92a2a; color: white; }
        .btn-remover:hover { background-color: #a12121; }
        .btn-efeito { background-color: #4a5a6a; color: #EAEAEA; font-size: 0.9em; }
        .btn-efeito:hover { background-color: #5f748a; }
        #btn-salvar-musica { background-color: #2a9d8f; color: white; }
        #btn-salvar-musica:hover { background-color: #268c7f; }
        
        .escala-controles { display: flex; justify-content: center; align-items: center; gap: 15px; margin-bottom: 25px; }
        .escala-controles label { font-family: 'Cinzel', serif; font-weight: 700; font-size: 1.2em; color: #ccc; }
        #escala-select { background-color: #444; color: #eaeaea; border: 1px solid #888; border-radius: 5px; padding: 8px 12px; font-family: 'Merriweather', serif; font-size: 1em; cursor: pointer; }
        #escala-display h3 { font-family: 'Cinzel', serif; font-weight: 700; color: #d4af37; font-size: 1.5em; margin: 15px 0 10px 0; text-align: center;}
        .nota-ponto { width: 26px; height: 26px; border-radius: 50%; z-index: 2; display: flex; justify-content: center; align-items: center; color: #262626; font-size: 0.8em; font-weight: bold; font-family: 'Roboto Mono', monospace; text-shadow: 1px 1px 2px rgba(0,0,0,0.3); }
        .nota-ponto.escala { background-color: #ffcc00; border: 1px solid #b38f00; }
        .nota-ponto.tonica { background-color: #2a9d8f; color: #EAEAEA; border: none; }
        .nota-ponto.outra { background-color: #4a4a4a; border: 1px solid #777; color: #ccc; }

        .btn-global { background: linear-gradient(145deg, #d4af37, #b18b21); color: #262626; border: none; padding: 12px 25px; border-radius: 8px; font-family: 'Cinzel Decorative', cursive; font-size: 1.2em; cursor: pointer; box-shadow: 0 4px 10px rgba(0,0,0,0.5); transition: all 0.2s ease-in-out; margin-top: 30px; }
        .btn-global:hover { transform: translateY(-2px); box-shadow: 0 6px 15px rgba(0,0,0,0.6); }
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.75); display: flex; justify-content: center; align-items: center; z-index: 1000; opacity: 0; visibility: hidden; transition: opacity 0.3s ease, visibility 0.3s ease; }
        .modal-overlay.visivel { opacity: 1; visibility: visible; }
        .modal-content { background-color: #333; padding: 25px; border-radius: 8px; box-shadow: 0 5px 20px rgba(0,0,0,0.5); width: 90%; max-width: 800px; max-height: 80vh; overflow-y: auto; position: relative; transform: scale(0.95); transition: transform 0.3s ease; }
        .modal-overlay.visivel .modal-content { transform: scale(1); }
        .modal-fechar { position: absolute; top: 10px; right: 15px; background: none; border: none; color: #aaa; font-size: 2.5em; line-height: 1; cursor: pointer; transition: color 0.2s ease; }
        .modal-fechar:hover { color: #fff; }

        #lista-acordes { display: grid; grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); gap: 15px; margin-top: 20px; }
        .acorde-item { background-color: #2a2a2a; border: 2px solid #555; border-radius: 5px; padding: 10px; font-family: 'Roboto Mono', monospace; white-space: pre; cursor: pointer; transition: all 0.2s; text-align: center; }
        .acorde-item:hover { background-color: #d4af37; color: #262626; transform: scale(1.05); border-color: #d4af37; }
        .acorde-item h4 { margin: 0 0 8px 0; font-family: 'Cinzel', serif; font-size: 1.1em; }
        
        .acorde-item.sugerido { background-color: #d4af37; color: #262626; transform: scale(1.05); border-color: #ffffff; box-shadow: 0 0 15px rgba(212, 175, 55, 0.7); }
        .acorde-item.desativado { opacity: 0.3; background-color: #2a2a2a; border-color: #555; transform: scale(1); cursor: default; }
        .acorde-item.desativado:hover { transform: scale(1); background-color: #2a2a2a; color: #EAEAEA; }
    </style>
</head>
<body>
    <h1>ESTÚDIO DE UKULELE</h1>
    <h2 style="font-size: 1.8em; margin-top: 0;">Editor de Tablaturas e Guia de Escalas</h2>
    <p class="introducao">Crie e salve suas tablaturas! Use o "Modo Solo Interativo": clique para ver notas vizinhas, arraste na horizontal para um SLIDE ou na vertical para um BEND.</p>

    <div class="cartao-principal">
        <h2>Editor Interativo de Tablatura</h2>
        
        <div class="escala-controles" style="margin-bottom: 10px; padding: 12px; background-color: rgba(0,0,0,0.15); border-radius: 8px; border: 1px solid #444;">
            <label for="escala-select"><strong>Modo Solo / Tonalidade:</strong></label>
            <select id="escala-select"></select>
        </div>
        <div class="legenda" style="margin-top: 10px; gap: 15px;">
            <div class="legenda-item"><div class="cor-legenda cor-sugestao"></div><span>Próxima Nota</span></div>
            <div class="legenda-item"><div class="cor-legenda cor-anterior"></div><span>Nota Anterior</span></div>
            <div class="legenda-item"><div class="cor-legenda cor-escala">N</div><span>Nota da Escala</span></div>
            <div class="legenda-item"><div class="cor-legenda cor-tonica">T</div><span>Tônica</span></div>
        </div>
        
        <div id="editor-wrapper">
             <div id="instrumento-editor" class="fretboard-container"></div>
             <div id="fret-numbers-container-wrapper" class="fret-numbers-container"></div>
        </div>

        <div id="efeitos-container">
            <label style="display:block; margin-top: 20px; font-weight: bold; color: #ccc;">Adicionar Efeitos (Botões):</label>
            <div class="botoes-container">
                <button class="btn-editor btn-efeito" data-efeito="h">Hammer-on (h)</button>
                <button class="btn-editor btn-efeito" data-efeito="p">Pull-off (p)</button>
                <button class="btn-editor btn-efeito" data-efeito="b">Bend (b)</button>
                <button class="btn-editor btn-efeito" data-efeito="/">Slide Up (/)</button>
                <button class="btn-editor btn-efeito" data-efeito="\">Slide Down (\)</button>
                <button class="btn-editor btn-efeito" data-efeito="~">Vibrato (~)</button>
            </div>
        </div>

        <label for="tablatura-texto" style="display:block; margin-top: 20px; font-weight: bold; color: #ccc;">Tablatura Gerada:</label>
        <textarea id="tablatura-texto" readonly></textarea>

        <div class="botoes-container">
            <button id="btn-salvar-musica" class="btn-editor">Salvar Música</button>
            <button id="btn-abrir-acordes" class="btn-editor">Acordes</button>
            <button id="btn-modo-acorde" class="btn-editor">Acorde Manual</button>
            <button id="btn-separar-parte" class="btn-editor btn-controle">Separar Parte</button>
            <button id="btn-desfazer" class="btn-editor btn-remover">Desfazer</button>
            <button id="btn-limpar" class="btn-editor btn-controle">Limpar Tab</button>
            <button id="btn-copiar" class="btn-editor btn-controle">Copiar Tab</button>
        </div>
    </div>

    <button id="btn-abrir-musicas-salvas" class="btn-global">Minhas Músicas Salvas</button>

    <div id="modal-musicas" class="modal-overlay">
        <div class="modal-content">
            <button id="btn-fechar-musicas" class="modal-fechar">&times;</button>
            <h2>Minhas Músicas Salvas</h2>
            <div id="lista-musicas-salvas"></div>
        </div>
    </div>

    <div id="modal-acordes" class="modal-overlay">
        <div class="modal-content">
            <button id="btn-fechar-acordes" class="modal-fechar">&times;</button>
            <h2>Biblioteca de Acordes</h2>
            <p>Os acordes da tonalidade selecionada estão ativos. Clique para adicionar e ver o próximo na sequência.</p>
            <div id="lista-acordes"></div>
        </div>
    </div>

    <div id="guia-escalas" class="cartao-principal" style="margin-top: 30px;">
        <h2>Guia Visual de Escalas Pentatônicas</h2>
        <p class="introducao" style="font-size: 0.9em; margin-top: -15px;">Selecione uma tonalidade no menu acima para visualizar o padrão completo da escala aqui.</p>
        
        <div id="escala-display"></div>
    </div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    // --- Configurações e Constantes para UKULELE ---
    const NUM_STRINGS = 4;
    const NUM_FRETS = 18;
    const tuning = ['A', 'E', 'C', 'G']; // Afinação padrão Ukulele (High G)
    const notesSharp = ['C', 'C#', 'D', 'D#', 'E', 'F', 'F#', 'G', 'G#', 'A', 'A#', 'B'];
    const openStringNotes = [notesSharp.indexOf('A'), notesSharp.indexOf('E'), notesSharp.indexOf('C'), notesSharp.indexOf('G')]; // [9, 4, 0, 7]
    
    // --- BIBLIOTECA DE ACORDES PARA UKULELE ---
    const chordLibrary = [
        { name: 'C Major', shape: ['3','0','0','0'] }, { name: 'C minor', shape: ['3','3','3','0'] },
        { name: 'D Major', shape: ['0','2','2','2'] }, { name: 'D minor', shape: ['0','1','2','2'] },
        { name: 'E Major', shape: ['2','0','4','1'] }, { name: 'E minor', shape: ['2','3','4','0'] },
        { name: 'F Major', shape: ['0','1','0','2'] }, { name: 'F minor', shape: ['3','1','0','1'] },
        { name: 'G Major', shape: ['2','3','2','0'] }, { name: 'G minor', shape: ['1','3','2','0'] },
        { name: 'A Major', shape: ['0','0','1','2'] }, { name: 'A minor', shape: ['0','0','0','2'] },
        { name: 'B Major', shape: ['2','2','3','4'] }, { name: 'B minor', shape: ['2','2','2','4'] },
    ];
    
    // Mapeamento da Tonalidade para acordes diatônicos de Ukulele
    const diatonicChords = {
        'C': ['C Major', 'D minor', 'E minor', 'F Major', 'G Major', 'A minor'],
        'G': ['G Major', 'A minor', 'B minor', 'C Major', 'D Major', 'E minor'],
        'D': ['D Major', 'E minor', 'G Major', 'A Major', 'B minor'],
        'A': ['A Major', 'B minor', 'D Major', 'E Major'],
        'E': ['E Major', 'A Major', 'B Major'],
        'B': ['B Major', 'E Major'],
        'F#': [],
        'C#': [],
        'F': ['F Major', 'G minor', 'A minor', 'C Major', 'D minor'],
        'A#': ['C minor', 'D minor', 'F Major', 'G minor'],
        'D#': ['F minor', 'G minor'],
        'G#': ['C minor'],
    };


    // --- Seleção dos Elementos do DOM ---
    const editorContainer = document.getElementById('instrumento-editor');
    const fretNumbersContainerWrapper = document.getElementById('fret-numbers-container-wrapper');
    const tabTexto = document.getElementById('tablatura-texto');
    const btnLimpar = document.getElementById('btn-limpar');
    const btnCopiar = document.getElementById('btn-copiar');
    const btnSalvarMusica = document.getElementById('btn-salvar-musica');
    const btnSepararParte = document.getElementById('btn-separar-parte');
    const btnModoAcorde = document.getElementById('btn-modo-acorde');
    const btnDesfazer = document.getElementById('btn-desfazer');
    const efeitosContainer = document.getElementById('efeitos-container');
    const modalMusicas = document.getElementById('modal-musicas');
    const btnAbrirMusicasSalvas = document.getElementById('btn-abrir-musicas-salvas');
    const btnFecharMusicas = document.getElementById('btn-fechar-musicas');
    const listaMusicasSalvas = document.getElementById('lista-musicas-salvas');
    const modalAcordes = document.getElementById('modal-acordes');
    const btnAbrirAcordes = document.getElementById('btn-abrir-acordes');
    const btnFecharAcordes = document.getElementById('btn-fechar-acordes');
    const listaAcordes = document.getElementById('lista-acordes');
    const escalaSelect = document.getElementById('escala-select');
    const escalaDisplay = document.getElementById('escala-display');

    // --- Variáveis de Estado ---
    let tabLines = [];
    let tabHistory = [];
    let lastPlayedStringIndex = -1;
    let skipNextSeparator = false;
    let isChordModeActive = false;
    let manualChord = {};
    
    let dragState = { isDragging: false, startX: 0, startY: 0, startFret: null, startString: null, startElement: null, dragType: 'none', didMove: false };

    // --- Funções de Geração da Interface ---
    function createFretboard(container, fretNumContainer, isEditor = false) {
        container.innerHTML = '';
        const fretboard = document.createElement('div');
        fretboard.className = 'fretboard';
        if (fretNumContainer) {
            fretNumContainer.innerHTML = '';
            const fretNumbers = document.createElement('div');
            fretNumbers.className = 'fret-numbers';
            for (let j = 0; j <= NUM_FRETS; j++) {
                const fretNumDiv = document.createElement('div');
                if (j > 0) fretNumDiv.textContent = j;
                fretNumbers.appendChild(fretNumDiv);
            }
            fretNumContainer.appendChild(fretNumbers);
        }
        for (let i = 0; i < NUM_STRINGS; i++) {
            const stringDiv = document.createElement('div');
            stringDiv.className = 'string';
            for (let j = 0; j <= NUM_FRETS; j++) {
                const fretDiv = document.createElement('div');
                fretDiv.className = 'fret';
                fretDiv.dataset.string = i;
                fretDiv.dataset.fret = j;
                const noteNameSpan = document.createElement('span');
                noteNameSpan.className = 'fret-note-name';
                fretDiv.appendChild(noteNameSpan);
                stringDiv.appendChild(fretDiv);
            }
            fretboard.appendChild(stringDiv);
        }
        // Marcadores de casas para Ukulele
        const markerFretsSingle = [5, 7, 10, 15];
        const markerFretsDouble = [12];
        const attachMarker = (fretNum, type) => {
            if (fretNum <= NUM_FRETS) {
                const hostFret = fretboard.children[1].children[fretNum]; // Marcador no meio do braço
                hostFret.classList.add('marker-host');
                const markerContainer = document.createElement('div');
                markerContainer.className = 'fret-marker-container';
                const marker = document.createElement('div');
                marker.className = `fret-marker ${type}`;
                if (type === 'single') marker.innerHTML = '●';
                markerContainer.appendChild(marker);
                hostFret.appendChild(markerContainer);
            }
        };
        markerFretsSingle.forEach(fretNum => attachMarker(fretNum, 'single'));
        markerFretsDouble.forEach(fretNum => attachMarker(fretNum, 'double'));
        container.appendChild(fretboard);
        if (isEditor) {
            fretboard.addEventListener('mousedown', handleFretMouseDown);
            editorContainer.addEventListener('scroll', () => fretNumbersContainerWrapper.scrollLeft = editorContainer.scrollLeft );
        }
        return fretboard;
    }

    // --- Funções de Estado e Tablatura ---
    const isTabEmpty = () => tabLines.every(line => line.replace(/[AECG|]/g, '').replace(/-/g, '').trim() === '');
    const saveState = () => { tabHistory.push(JSON.parse(JSON.stringify(tabLines))); };
    const undoLastAction = () => {
        if (isChordModeActive) toggleChordMode();
        if (tabHistory.length === 0) return;
        tabLines = tabHistory.pop();
        lastPlayedStringIndex = -1;
        clearSoloHighlights();
        updateTabText();
    };
    const initTab = () => {
        if (isChordModeActive) toggleChordMode();
        tabLines = tuning.map(s => s.padEnd(2, ' ') + '|');
        tabHistory = [];
        lastPlayedStringIndex = -1;
        skipNextSeparator = true;
        clearSoloHighlights();
        updateTabText();
        escalaSelect.dispatchEvent(new Event('change'));
    };
    const updateTabText = () => {
        let maxLength = 0;
        if (tabLines.length > 0 && tabLines[0].length > 0) maxLength = Math.max(...tabLines.map(line => line.length));
        tabTexto.value = tabLines.map(line => line.padEnd(maxLength, '-')).join('\n');
        tabTexto.scrollTop = tabTexto.scrollHeight;
    };
    const addPartSeparator = () => {
        saveState();
        if (isChordModeActive) toggleChordMode();
        if (tabLines[0].length <= 3) return;
        tabLines = tabLines.map(line => line + '--||');
        skipNextSeparator = true;
        lastPlayedStringIndex = -1;
        clearSoloHighlights();
        updateTabText();
    };
    const addSingleNoteToTab = (stringIndex, char) => {
        saveState();
        const charStr = char.toString();
        if (!skipNextSeparator) tabLines = tabLines.map(line => line + '--');
        const maxLength = Math.max(...tabLines.map(line => line.length));
        for (let i = 0; i < NUM_STRINGS; i++) {
            tabLines[i] = tabLines[i].padEnd(maxLength, '-');
            if (i === stringIndex) tabLines[i] += charStr;
            else tabLines[i] += '-'.repeat(charStr.length);
        }
        skipNextSeparator = false;
        updateTabText();
    };
    const addComplexNotationToTab = (stringIndex, notation) => {
        saveState();
        if (!skipNextSeparator) tabLines = tabLines.map(line => line + '--');
        const maxLength = Math.max(...tabLines.map(line => line.length));
        for (let i = 0; i < NUM_STRINGS; i++) {
            tabLines[i] = tabLines[i].padEnd(maxLength, '-');
            if (i === stringIndex) tabLines[i] += notation;
            else tabLines[i] += '-'.repeat(notation.length);
        }
        skipNextSeparator = false;
        updateTabText();
    };
    const addEffectToTab = (effect) => {
        if (isChordModeActive || lastPlayedStringIndex === -1 || tabLines[0].length <= 3) return;
        saveState();
        const maxLength = Math.max(...tabLines.map(line => line.length));
        for (let i = 0; i < NUM_STRINGS; i++) {
            tabLines[i] = tabLines[i].padEnd(maxLength, '-');
            if (i === lastPlayedStringIndex) tabLines[i] += effect;
            else tabLines[i] += '-'.repeat(effect.length);
        }
        skipNextSeparator = ['h', 'p', '/', '\\'].includes(effect);
        updateTabText();
    };
    const addChordToTab = (chordShape) => {
        saveState();
        if (!skipNextSeparator) tabLines = tabLines.map(line => line + '--');
        const contentMaxLength = Math.max(...chordShape.map(n => n.toString().length));
        const currentTabMaxLength = Math.max(...tabLines.map(line => line.length));
        for (let i = 0; i < NUM_STRINGS; i++) {
            const note = chordShape[i].toString();
            const paddedNote = note.padStart(contentMaxLength, '-');
            tabLines[i] = tabLines[i].padEnd(currentTabMaxLength, '-') + paddedNote;
        }
        skipNextSeparator = false;
        lastPlayedStringIndex = -1;
        updateTabText();
    };

    // --- Lógica do Modo de Acorde Manual ---
    const toggleChordMode = () => {
        isChordModeActive = !isChordModeActive;
        btnModoAcorde.classList.toggle('active-mode', isChordModeActive);
        clearSoloHighlights(); 
        if (isChordModeActive) {
            btnModoAcorde.textContent = 'Finalizar Acorde';
            manualChord = {};
        } else {
            btnModoAcorde.textContent = 'Acorde Manual';
            if (Object.keys(manualChord).length > 0) {
                const shape = Array(NUM_STRINGS).fill('x');
                for (const stringIdx in manualChord) shape[stringIdx] = manualChord[stringIdx];
                addChordToTab(shape);
            }
            clearChordHighlights();
            manualChord = {};
        }
    };
    const handleChordBuildingClick = (fretElement) => {
        const stringIndex = parseInt(fretElement.dataset.string);
        const fretNumber = parseInt(fretElement.dataset.fret);
        if (manualChord[stringIndex] === fretNumber) {
            delete manualChord[stringIndex];
            fretElement.classList.remove('fret-selecionado');
            return;
        }
        if (manualChord[stringIndex] !== undefined) {
            const oldFret = manualChord[stringIndex];
            const oldFretEl = editorContainer.querySelector(`.fret[data-string='${stringIndex}'][data-fret='${oldFret}']`);
            if(oldFretEl) oldFretEl.classList.remove('fret-selecionado');
        }
        manualChord[stringIndex] = fretNumber;
        fretElement.classList.add('fret-selecionado');
    };
    const clearChordHighlights = () => { editorContainer.querySelectorAll('.fret-selecionado').forEach(el => el.classList.remove('fret-selecionado')); };

    // --- Lógica de Arrastar e Clicar (Drag and Drop) ---
    function handleFretMouseDown(event) {
        event.preventDefault();
        const fretEl = event.target.closest('.fret');
        if (!fretEl || fretEl.classList.contains('desativado') || isChordModeActive) return;

        dragState = { isDragging: true, startX: event.clientX, startY: event.clientY, startFret: parseInt(fretEl.dataset.fret), startString: parseInt(fretEl.dataset.string), startElement: fretEl, dragType: 'none', didMove: false };
        
        fretEl.classList.add('dragging');
        const noteNameSpan = fretEl.querySelector('.fret-note-name');
        if (noteNameSpan) noteNameSpan.textContent = getNoteName((openStringNotes[dragState.startString] + dragState.startFret) % 12);
        
        document.addEventListener('mousemove', handleDocumentMouseMove);
        document.addEventListener('mouseup', handleDocumentMouseUp);
    }

    function handleDocumentMouseMove(event) {
        if (!dragState.isDragging) return;
        dragState.didMove = true;
        const deltaX = event.clientX - dragState.startX;
        const deltaY = event.clientY - dragState.startY;
        if (dragState.dragType === 'none' && (Math.abs(deltaX) > 15 || Math.abs(deltaY) > 15)) {
            dragState.dragType = Math.abs(deltaX) > Math.abs(deltaY) ? 'slide' : 'bend';
        }
        if (dragState.dragType === 'bend') {
            dragState.startElement.querySelector('.fret-note-name').style.transform = `translateY(${deltaY}px)`;
        } else if (dragState.dragType === 'slide') {
            highlightSlideTargets();
        }
    }

    function handleDocumentMouseUp(event) {
        if (!dragState.isDragging) return;
        const startEl = dragState.startElement;
        if (dragState.dragType === 'slide') {
            const endEl = event.target.closest('.fret');
            if (endEl && endEl.classList.contains('slide-target')) {
                const endFret = parseInt(endEl.dataset.fret);
                const notation = `${dragState.startFret}${endFret > dragState.startFret ? '/' : '\\'}${endFret}`;
                addComplexNotationToTab(dragState.startString, notation);
                lastPlayedStringIndex = dragState.startString;
                highlightAdjacentScaleNotes(dragState.startString, endFret);
            }
        } else if (dragState.dragType === 'bend') {
            addSingleNoteToTab(dragState.startString, dragState.startFret);
            lastPlayedStringIndex = dragState.startString;
            addEffectToTab('b');
            highlightAdjacentScaleNotes(dragState.startString, dragState.startFret);
        } else {
            addSingleNoteToTab(dragState.startString, dragState.startFret);
            lastPlayedStringIndex = dragState.startString;
            highlightAdjacentScaleNotes(dragState.startString, dragState.startFret);
        }
        startEl.classList.remove('dragging');
        startEl.querySelector('.fret-note-name').style.transform = 'translateY(0)';
        editorContainer.querySelectorAll('.fret').forEach(f => f.classList.remove('slide-target'));
        document.removeEventListener('mousemove', handleDocumentMouseMove);
        document.removeEventListener('mouseup', handleDocumentMouseUp);
        dragState.isDragging = false;
    }

    // --- Lógica dos Botões e Modais ---
    efeitosContainer.addEventListener('click', (event) => { const button = event.target.closest('.btn-efeito'); if (button && button.dataset.efeito) addEffectToTab(button.dataset.efeito); });
    btnDesfazer.addEventListener('click', undoLastAction);
    btnSepararParte.addEventListener('click', addPartSeparator);
    btnLimpar.addEventListener('click', initTab);
    btnModoAcorde.addEventListener('click', toggleChordMode);
    btnCopiar.addEventListener('click', () => { if (!tabTexto.value) return; navigator.clipboard.writeText(tabTexto.value).then(() => { const originalText = btnCopiar.textContent; btnCopiar.textContent = 'Copiado!'; setTimeout(() => { btnCopiar.textContent = originalText; }, 1500); }); });
    btnSalvarMusica.addEventListener('click', () => {
        if (isTabEmpty()) { alert('A tablatura está vazia!'); return; }
        const nomeMusica = prompt('Digite um nome para a sua música:');
        if (!nomeMusica || nomeMusica.trim() === '') { alert('Nome inválido. A música não foi salva.'); return; }
        const musicas = JSON.parse(localStorage.getItem('minhasMusicasUkulele')) || [];
        musicas.push({ nome: nomeMusica.trim(), tab: tabTexto.value });
        localStorage.setItem('minhasMusicasUkulele', JSON.stringify(musicas));
        alert(`Música "${nomeMusica}" salva com sucesso!`);
        initTab();
    });

    btnAbrirMusicasSalvas.addEventListener('click', () => { renderizarMusicasSalvas(); modalMusicas.classList.add('visivel'); });
    btnFecharMusicas.addEventListener('click', () => modalMusicas.classList.remove('visivel'));
    
    const clearChordSuggestions = () => { listaAcordes.querySelectorAll('.acorde-item').forEach(el => el.classList.remove('sugerido', 'desativado')); };
    btnAbrirAcordes.addEventListener('click', () => {
        renderizarBibliotecaAcordes();
        clearChordSuggestions();
        const rootNote = escalaSelect.value;
        if (rootNote && rootNote !== 'nenhuma') {
            const validChords = diatonicChords[rootNote] || [];
            listaAcordes.querySelectorAll('.acorde-item').forEach(item => {
                const itemName = item.querySelector('h4').textContent;
                if (!validChords.includes(itemName)) {
                    item.classList.add('desativado');
                }
            });
        }
        modalAcordes.classList.add('visivel');
    });
    
    btnFecharAcordes.addEventListener('click', () => modalAcordes.classList.remove('visivel'));
    
    listaAcordes.addEventListener('click', (event) => {
        const chordItem = event.target.closest('.acorde-item');
        if (chordItem && !chordItem.classList.contains('desativado')) {
            const chordIndex = parseInt(chordItem.dataset.chordIndex);
            const clickedChord = chordLibrary[chordIndex];
            addChordToTab(clickedChord.shape.slice().reverse()); // Ukulele chords stored high-to-low, tab needs low-to-high

            const rootNote = escalaSelect.value;
            if (rootNote && rootNote !== 'nenhuma') {
                const validChords = diatonicChords[rootNote] || [];
                const clickedChordIndexInKey = validChords.indexOf(clickedChord.name);
                
                if (clickedChordIndexInKey !== -1) {
                    const nextChordIndex = (clickedChordIndexInKey + 1) % validChords.length;
                    const nextChordName = validChords[nextChordIndex];
                    
                    clearChordSuggestions();
                    
                    listaAcordes.querySelectorAll('.acorde-item').forEach(item => {
                        const itemName = item.querySelector('h4').textContent;
                        if (itemName === nextChordName) {
                            item.classList.add('sugerido');
                        } else if (!validChords.includes(itemName)) {
                            item.classList.add('desativado');
                        }
                    });
                }
            }
        }
    });

    function renderizarMusicasSalvas() {
        listaMusicasSalvas.innerHTML = '';
        const musicas = JSON.parse(localStorage.getItem('minhasMusicasUkulele')) || [];
        if (musicas.length === 0) { listaMusicasSalvas.innerHTML = '<p>Nenhuma música salva ainda.</p>'; return; }
        musicas.forEach((musica, index) => {
            const musicaItem = document.createElement('div');
            const safeName = musica.nome.replace(/</g, "&lt;").replace(/>/g, "&gt;");
            const safeTab = musica.tab.replace(/</g, "&lt;").replace(/>/g, "&gt;");
            musicaItem.innerHTML = `<div class="musica-header"><h3>${safeName}</h3><button class="btn-excluir-musica" data-index="${index}">&times;</button></div><pre class="tab-salva">${safeTab}</pre>`;
            listaMusicasSalvas.appendChild(musicaItem);
        });
    }
    listaMusicasSalvas.addEventListener('click', (event) => {
        if (event.target.classList.contains('btn-excluir-musica') && confirm('Tem a certeza que deseja excluir esta música?')) {
            const index = event.target.dataset.index;
            let musicas = JSON.parse(localStorage.getItem('minhasMusicasUkulele')) || [];
            musicas.splice(index, 1);
            localStorage.setItem('minhasMusicasUkulele', JSON.stringify(musicas));
            renderizarMusicasSalvas();
        }
    });

    function renderizarBibliotecaAcordes() {
        if (listaAcordes.children.length > 0) return;
        chordLibrary.forEach((chord, index) => {
            const acordeItem = document.createElement('div');
            acordeItem.className = 'acorde-item';
            acordeItem.dataset.chordIndex = index;
            let tabDiagram = '';
            // Ukulele tab diagram
            const shape = chord.shape.slice().reverse(); // GCEA order for diagram
            const ukeTuning = ['A', 'E', 'C', 'G'];
            for(let i = 0; i < ukeTuning.length; i++) {
                 tabDiagram += `${ukeTuning[i]}|-${chord.shape[i]}-|\n`;
            }
            acordeItem.innerHTML = `<h4>${chord.name}</h4><pre>${tabDiagram.trim()}</pre>`;
            listaAcordes.appendChild(acordeItem);
        });
    }

    // --- Lógica do Guia de Escalas e MODO SOLO ---
    function getNoteName(noteIndex) { return notesSharp[noteIndex % 12]; }
    function getPentatonicMajor(rootNote) { const rootIndex = notesSharp.indexOf(rootNote); return [ rootIndex % 12, (rootIndex + 2) % 12, (rootIndex + 4) % 12, (rootIndex + 7) % 12, (rootIndex + 9) % 12 ]; }
    
    function clearSoloHighlights() { 
        editorContainer.querySelectorAll('.fret').forEach(el => {
            el.classList.remove('proxima-nota-sugerida', 'nota-anterior-sugerida', 'escala-completa', 'desativado', 'slide-target');
            el.querySelector('.fret-note-name').textContent = '';
        });
    }

    function highlightFullScale(rootNote) {
        clearSoloHighlights();
        if (!rootNote || rootNote === 'nenhuma') return;
        const scaleNotes = getPentatonicMajor(rootNote);
        const editorFretboard = editorContainer.querySelector('.fretboard');
        for (let i = 0; i < NUM_STRINGS; i++) {
            for (let j = 0; j <= NUM_FRETS; j++) {
                const fretEl = editorFretboard.children[i].children[j];
                const currentNoteIndex = (openStringNotes[i] + j) % 12;
                if (scaleNotes.includes(currentNoteIndex)) {
                    fretEl.classList.add('escala-completa');
                    fretEl.querySelector('.fret-note-name').textContent = getNoteName(currentNoteIndex);
                }
            }
        }
    }

    function highlightAdjacentScaleNotes(clickedStringIndex, clickedFretNumber) {
        clearSoloHighlights();
        const rootNote = escalaSelect.value;
        if (!rootNote || rootNote === 'nenhuma') return;
        const scaleNotes = getPentatonicMajor(rootNote);
        const clickedNoteIndex = (openStringNotes[clickedStringIndex] + clickedFretNumber) % 12;
        const indexOfClickedNoteInScale = scaleNotes.indexOf(clickedNoteIndex);
        
        if (indexOfClickedNoteInScale === -1) {
            editorContainer.querySelectorAll('.fret').forEach(fretEl => {
                const noteIdx = (openStringNotes[parseInt(fretEl.dataset.string)] + parseInt(fretEl.dataset.fret)) % 12;
                if (!scaleNotes.includes(noteIdx)) fretEl.classList.add('desativado');
            });
            return;
        }

        const prevNoteIndexInScale = (indexOfClickedNoteInScale - 1 + scaleNotes.length) % scaleNotes.length;
        const nextNoteIndexInScale = (indexOfClickedNoteInScale + 1) % scaleNotes.length;
        const prevScaleNote = scaleNotes[prevNoteIndexInScale];
        const nextScaleNote = scaleNotes[nextNoteIndexInScale];
        
        const FRET_PROXIMITY = 5;
        const editorFretboard = editorContainer.querySelector('.fretboard');

        for (let i = 0; i < NUM_STRINGS; i++) {
            for (let j = 0; j <= NUM_FRETS; j++) {
                const fretEl = editorFretboard.children[i].children[j];
                const currentNoteIndex = (openStringNotes[i] + j) % 12;
                if (!scaleNotes.includes(currentNoteIndex)) {
                    fretEl.classList.add('desativado');
                } else {
                    const isProximate = (Math.abs(j - clickedFretNumber) <= FRET_PROXIMITY) || (j === 0 && clickedFretNumber <= FRET_PROXIMITY);
                    const noteNameSpan = fretEl.querySelector('.fret-note-name');
                    if (currentNoteIndex === nextScaleNote && isProximate) {
                        fretEl.classList.add('proxima-nota-sugerida');
                        noteNameSpan.textContent = getNoteName(currentNoteIndex);
                    } else if (currentNoteIndex === prevScaleNote && isProximate) {
                        fretEl.classList.add('nota-anterior-sugerida');
                        noteNameSpan.textContent = getNoteName(currentNoteIndex);
                    }
                }
            }
        }
    }
    
    function highlightSlideTargets() {
        const rootNote = escalaSelect.value;
        if (!rootNote || rootNote === 'nenhuma') return;
        const scaleNotes = getPentatonicMajor(rootNote);
        const stringRow = dragState.startElement.parentElement;
        stringRow.querySelectorAll('.fret').forEach(fretEl => {
            fretEl.classList.remove('slide-target');
            const fretNumber = parseInt(fretEl.dataset.fret);
            if(fretNumber === dragState.startFret) return;
            const currentNoteIndex = (openStringNotes[dragState.startString] + fretNumber) % 12;
            if (scaleNotes.includes(currentNoteIndex)) {
                fretEl.classList.add('slide-target');
            }
        });
    }

    function populateScaleSelector() {
        escalaSelect.innerHTML = '';
        const defaultOption = document.createElement('option');
        defaultOption.value = 'nenhuma';
        defaultOption.textContent = '--- Desativado ---';
        escalaSelect.appendChild(defaultOption);
        const scaleOrder = ['C', 'G', 'D', 'A', 'E', 'B', 'F#', 'C#', 'F', 'A#', 'D#', 'G#'];
        scaleOrder.forEach(rootNote => {
            const rootIndex = notesSharp.indexOf(rootNote);
            const relativeMinorIndex = (rootIndex + 9) % 12; 
            const option = document.createElement('option');
            option.value = rootNote;
            option.textContent = `${getNoteName(rootIndex)} Maior / ${getNoteName(relativeMinorIndex)}m`;
            escalaSelect.appendChild(option);
        });
    }

    function displaySelectedScale(rootNote) {
        escalaDisplay.innerHTML = '';
        if (!rootNote || rootNote === 'nenhuma') {
            escalaDisplay.innerHTML = '<p style="text-align:center; color: #888;">Selecione uma tonalidade acima para ver o diagrama completo.</p>';
            return;
        }
        const scaleNotes = getPentatonicMajor(rootNote);
        const rootIndex = scaleNotes[0];
        const title = document.createElement('h3');
        title.innerHTML = `Visualização da Escala de ${getNoteName(rootIndex)} Maior Pentatônica`;
        const fretboardContainer = document.createElement('div');
        fretboardContainer.className = 'fretboard-container';
        const fretboard = createFretboard(fretboardContainer, null, false);
        for (let i = 0; i < NUM_STRINGS; i++) {
            for (let j = 0; j <= NUM_FRETS; j++) {
                const currentNoteIndex = (openStringNotes[i] + j) % 12;
                const noteDot = document.createElement('div');
                noteDot.className = 'nota-ponto';
                noteDot.textContent = getNoteName(currentNoteIndex);
                if (scaleNotes.includes(currentNoteIndex)) {
                    noteDot.classList.add('escala');
                    if (currentNoteIndex === rootIndex) noteDot.classList.add('tonica');
                } else {
                    noteDot.classList.add('outra');
                }
                fretboard.children[i].children[j].appendChild(noteDot);
            }
        }
        escalaDisplay.appendChild(title);
        escalaDisplay.appendChild(fretboardContainer);
    }

    // --- Inicialização ---
    createFretboard(editorContainer, fretNumbersContainerWrapper, true);
    initTab();
    populateScaleSelector();
    escalaSelect.addEventListener('change', (e) => {
        displaySelectedScale(e.target.value);
        if (isTabEmpty()) {
            highlightFullScale(e.target.value);
        } else {
            clearSoloHighlights();
        }
    });
    displaySelectedScale(escalaSelect.value);
});
</script>

</body>
</html>
