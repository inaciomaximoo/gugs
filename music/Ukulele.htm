<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Estúdio de Ukulele - Editor e Escalas</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel+Decorative:wght@700&family=Cinzel:wght@400;700&family=Roboto+Mono:wght@400;700&family=Merriweather:ital,wght@0,400;0,700;1,400&display=swap" rel="stylesheet">
    <style>
        /* Estilos base */
        body { font-family: 'Merriweather', serif; background-color: #262626; color: #EAEAEA; margin: 0; padding: 20px; display: flex; flex-direction: column; align-items: center; }
        h1 { font-family: 'Cinzel Decorative', cursive; color: #EAEAEA; font-size: 3.5em; text-align: center; text-shadow: 2px 2px 4px rgba(0,0,0,0.4); margin-bottom: 0; }
        h2 { font-family: 'Cinzel', serif; color: #d4af37; text-align: center; margin-top: 40px; font-size: 2.2em; letter-spacing: 2px; font-weight: 700; }
        .introducao { max-width: 900px; text-align: center; color: #ccc; margin-bottom: 20px; line-height: 1.7; }
        .legenda { display: flex; flex-wrap: wrap; gap: 20px; margin-top: 20px; margin-bottom: 30px; align-items: center; justify-content: center; background-color: rgba(0,0,0,0.2); padding: 10px 20px; border-radius: 10px; border: 1px solid #444; }
        .legenda-item { display: flex; align-items: center; gap: 8px; font-weight: bold; }
        .cor-legenda { width: 20px; height: 20px; border-radius: 50%; box-shadow: 0 2px 4px rgba(0,0,0,0.2); display: flex; justify-content: center; align-items: center; font-size: 0.7em; font-weight: bold; color: #262626;}
        .cor-escala { background-color: #ffcc00; border: 1px solid #b38f00; }
        .cor-tonica { background-color: #2a9d8f; color: #EAEAEA; }
        .cor-outra { background-color: #4a4a4a; border: 1px solid #777; color: #ccc; }
        .container { display: flex; flex-wrap: wrap; justify-content: center; gap: 25px; max-width: 1200px; width: 100%;}
        .cartao-principal { background-color: #333; border-radius: 8px; box-shadow: 0 4px 15px rgba(0,0,0,0.4); width: 100%; max-width: 1100px; padding: 20px; border: 1px solid #555; box-sizing: border-box; }

        /*========= VISUALIZAÇÃO DO BRAÇO DO UKULELE =========*/
        .fretboard-container { overflow-x: auto; padding-bottom: 10px; border: 1px solid #1a1a1a; border-radius: 5px; background: linear-gradient(90deg, #382c21, #241b14); }
        .fretboard { display: flex; flex-direction: column; width: fit-content; }
        .string { display: flex; align-items: center; border-bottom: 1px solid #4a3a2d; }
        .string:last-child { border-bottom: none; }
        .fret { box-sizing: border-box; height: 42px; border-right: 2px solid #a88a76; position: relative; cursor: pointer; display: flex; justify-content: center; align-items: center; transition: background-color 0.2s; }
        .fret:hover { background-color: rgba(212, 175, 55, 0.2); }
        .fret:nth-child(1) { width: 35px; background-color: #291810; border-right: 4px solid #1a1a1a; }
        .fret:nth-child(2) { width: 65px; } .fret:nth-child(3) { width: 62px; } .fret:nth-child(4) { width: 59px; } .fret:nth-child(5) { width: 56px; }
        .fret:nth-child(6) { width: 54px; } .fret:nth-child(7) { width: 52px; } .fret:nth-child(8) { width: 50px; } .fret:nth-child(9) { width: 48px; }
        .fret:nth-child(10) { width: 46px; } .fret:nth-child(11) { width: 45px; } .fret:nth-child(n+12) { width: 44px; }

        .fret.fret-selecionado { background-color: rgba(46, 204, 113, 0.4); box-shadow: inset 0 0 10px rgba(46, 204, 113, 0.8); }

        .marker-host { position: relative; }
        .fret-marker-container { position: absolute; left: 50%; top: -150%; transform: translateX(-50%); height: 400%; width: 100%; display: flex; align-items: center; justify-content: center; z-index: 0; pointer-events: none; }
        .fret-marker { color: rgba(255, 255, 255, 0.25); text-align: center; }
        .fret-marker.single { font-size: 1.1em; }
        .fret-marker.double { font-size: 0.7em; line-height: 1.4; }
        .fret-marker.double::before, .fret-marker.double::after { content: '●'; display: block; }

        .fret-numbers-container { overflow-x: auto; scrollbar-width: none; -ms-overflow-style: none; } .fret-numbers-container::-webkit-scrollbar { display: none; }
        .fret-numbers { display: flex; width: fit-content; }
        .fret-numbers div { flex-shrink: 0; box-sizing: border-box; text-align: center; color: #d4af37; font-family: 'Cinzel', serif; padding-top: 5px; }
        .fret-numbers div:nth-child(1) { width: 35px; }
        .fret-numbers div:nth-child(2) { width: 65px; } .fret-numbers div:nth-child(3) { width: 62px; } .fret-numbers div:nth-child(4) { width: 59px; } .fret-numbers div:nth-child(5) { width: 56px; }
        .fret-numbers div:nth-child(6) { width: 54px; } .fret-numbers div:nth-child(7) { width: 52px; } .fret-numbers div:nth-child(8) { width: 50px; } .fret-numbers div:nth-child(9) { width: 48px; }
        .fret-numbers div:nth-child(10) { width: 46px; } .fret-numbers div:nth-child(11) { width: 45px; } .fret-numbers div:nth-child(n+12) { width: 44px; }

        /* Estilos da Tablatura e Controles */
        #tablatura-texto { width: 100%; height: 120px; background-color: #2a2a2a; border: 1px solid #555; color: #ccc; font-family: 'Roboto Mono', monospace; font-size: 1.1em; padding: 10px; border-radius: 5px; margin-top: 15px; box-sizing: border-box; line-height: 1.5; resize: vertical; white-space: pre; }
        .botoes-container { display: flex; flex-wrap: wrap; gap: 10px; justify-content: center; margin-top: 15px; }
        .btn-editor { background-color: #d4af37; color: #262626; border: none; padding: 10px 15px; border-radius: 5px; font-family: 'Cinzel', serif; font-weight: 700; font-size: 1em; cursor: pointer; box-shadow: 0 2px 5px rgba(0,0,0,0.3); transition: background-color 0.2s ease, box-shadow 0.2s ease, color 0.2s ease; }
        .btn-editor:hover { background-color: #f7d065; box-shadow: 0 4px 8px rgba(0,0,0,0.4); }
        .btn-editor.active-mode { background-color: #c92a2a; color: white; }
        .btn-editor.active-mode:hover { background-color: #e74c3c; }
        .btn-controle { background-color: #555; color: #EAEAEA; }
        .btn-controle:hover { background-color: #777; }
        .btn-efeito { background-color: #4a5a6a; color: #EAEAEA; font-size: 0.9em; }
        .btn-efeito:hover { background-color: #5f748a; }
        #btn-salvar-musica { background-color: #2a9d8f; color: white; }
        #btn-salvar-musica:hover { background-color: #268c7f; }
        
        /* Estilos do Guia de Escalas */
        .escala-controles { display: flex; justify-content: center; align-items: center; gap: 15px; margin-bottom: 25px; }
        .escala-controles label { font-family: 'Cinzel', serif; font-weight: 700; font-size: 1.2em; color: #ccc; }
        #escala-select { background-color: #444; color: #eaeaea; border: 1px solid #888; border-radius: 5px; padding: 8px 12px; font-family: 'Merriweather', serif; font-size: 1em; cursor: pointer; }
        #escala-display h3 { font-family: 'Cinzel', serif; font-weight: 700; color: #d4af37; font-size: 1.5em; margin: 15px 0 10px 0; text-align: center;}
        .nota-ponto { width: 26px; height: 26px; border-radius: 50%; z-index: 2; display: flex; justify-content: center; align-items: center; color: #262626; font-size: 0.8em; font-weight: bold; font-family: 'Roboto Mono', monospace; text-shadow: 1px 1px 2px rgba(0,0,0,0.3); }
        .nota-ponto.escala { background-color: #ffcc00; border: 1px solid #b38f00; }
        .nota-ponto.tonica { background-color: #2a9d8f; color: #EAEAEA; border: none; }
        .nota-ponto.outra { background-color: #4a4a4a; border: 1px solid #777; color: #ccc; }

        /* Estilos do Modal */
        .btn-global { background: linear-gradient(145deg, #d4af37, #b18b21); color: #262626; border: none; padding: 12px 25px; border-radius: 8px; font-family: 'Cinzel Decorative', cursive; font-size: 1.2em; cursor: pointer; box-shadow: 0 4px 10px rgba(0,0,0,0.5); transition: all 0.2s ease-in-out; margin-top: 30px; }
        .btn-global:hover { transform: translateY(-2px); box-shadow: 0 6px 15px rgba(0,0,0,0.6); }
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.75); display: flex; justify-content: center; align-items: center; z-index: 1000; opacity: 0; visibility: hidden; transition: opacity 0.3s ease, visibility 0.3s ease; }
        .modal-overlay.visivel { opacity: 1; visibility: visible; }
        .modal-content { background-color: #333; padding: 25px; border-radius: 8px; box-shadow: 0 5px 20px rgba(0,0,0,0.5); width: 90%; max-width: 800px; max-height: 80vh; overflow-y: auto; position: relative; transform: scale(0.95); transition: transform 0.3s ease; }
        .modal-overlay.visivel .modal-content { transform: scale(1); }
        .modal-fechar { position: absolute; top: 10px; right: 15px; background: none; border: none; color: #aaa; font-size: 2.5em; line-height: 1; cursor: pointer; transition: color 0.2s ease; }
        .modal-fechar:hover { color: #fff; }

        /* Estilos da Biblioteca de Acordes */
        #lista-acordes { display: grid; grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); gap: 15px; margin-top: 20px; }
        .acorde-item { background-color: #2a2a2a; border: 1px solid #555; border-radius: 5px; padding: 10px; font-family: 'Roboto Mono', monospace; white-space: pre; cursor: pointer; transition: background-color 0.2s, transform 0.2s; text-align: center; font-size: 0.9em; }
        .acorde-item:hover { background-color: #d4af37; color: #262626; transform: scale(1.05); }
        .acorde-item h4 { margin: 0 0 8px 0; font-family: 'Cinzel', serif; font-size: 1.1em; }
    </style>
</head>
<body>
    <h1>Estúdio de Ukulele</h1>
    <h2 style="font-size: 1.8em; margin-top: 0;">Editor de Tablaturas e Guia de Escalas</h2>
    <p class="introducao">Crie e salve suas tablaturas de ukulele! Clique no braço do instrumento, adicione acordes da biblioteca ou crie o seu com o modo "Acorde Manual".</p>

    <div class="cartao-principal">
        <h2>Editor Interativo de Tablatura</h2>
        <div id="editor-wrapper">
             <div id="ukulele-editor" class="fretboard-container"></div>
            <div id="fret-numbers-container-wrapper" class="fret-numbers-container"></div>
        </div>

        <div id="efeitos-container">
            <label style="display:block; margin-top: 20px; font-weight: bold; color: #ccc;">Adicionar Efeitos à Última Nota:</label>
            <div class="botoes-container">
                <button class="btn-editor btn-efeito" data-efeito="h">Hammer-on (h)</button>
                <button class="btn-editor btn-efeito" data-efeito="p">Pull-off (p)</button>
                <button class="btn-editor btn-efeito" data-efeito="/">Slide (/)</button>
                <button class="btn-editor btn-efeito" data-efeito="~">Vibrato (~)</button>
                <button class="btn-editor btn-efeito" data-efeito="x">Mute Strum (x)</button>
            </div>
        </div>

        <label for="tablatura-texto" style="display:block; margin-top: 20px; font-weight: bold; color: #ccc;">Tablatura Gerada:</label>
        <textarea id="tablatura-texto" readonly></textarea>

        <div class="botoes-container">
            <button id="btn-salvar-musica" class="btn-editor">Salvar Música</button>
            <button id="btn-abrir-acordes" class="btn-editor">Acordes</button>
            <button id="btn-modo-acorde" class="btn-editor">Acorde Manual</button>
            <button id="btn-separar-parte" class="btn-editor btn-controle">Separar Parte</button>
            <button id="btn-limpar" class="btn-editor btn-controle">Limpar Tab</button>
            <button id="btn-copiar" class="btn-editor btn-controle">Copiar Tab</button>
        </div>
    </div>

    <button id="btn-abrir-musicas-salvas" class="btn-global">Minhas Músicas Salvas</button>

    <div id="modal-musicas" class="modal-overlay">
        <div class="modal-content">
            <button id="btn-fechar-musicas" class="modal-fechar">&times;</button>
            <h2>Minhas Músicas Salvas</h2>
            <div id="lista-musicas-salvas"></div>
        </div>
    </div>

    <div id="modal-acordes" class="modal-overlay">
        <div class="modal-content">
            <button id="btn-fechar-acordes" class="modal-fechar">&times;</button>
            <h2>Biblioteca de Acordes de Ukulele</h2>
            <p>Clique em um acorde para adicioná-lo à sua tablatura.</p>
            <div id="lista-acordes"></div>
        </div>
    </div>

    <div id="guia-escalas" class="cartao-principal" style="margin-top: 30px;">
        <h2>Guia Visual de Escalas Pentatônicas</h2>
        <p class="introducao" style="font-size: 0.9em; margin-top: -15px;">Selecione uma tonalidade para visualizar todas as notas no braço do ukulele. As notas da escala são destacadas em amarelo e a tônica em verde.</p>

        <div class="escala-controles">
            <label for="escala-select">Selecionar Escala:</label>
            <select id="escala-select"></select>
        </div>

        <div class="legenda">
            <div class="legenda-item"><div class="cor-legenda cor-escala">N</div><span>Nota da Escala</span></div>
            <div class="legenda-item"><div class="cor-legenda cor-tonica">T</div><span>Nota Tônica</span></div>
            <div class="legenda-item"><div class="cor-legenda cor-outra">N</div><span>Outra Nota</span></div>
        </div>
        
        <div id="escala-display"></div>
    </div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    // --- Configurações e Constantes para UKULELE ---
    const NUM_STRINGS = 4;
    const NUM_FRETS = 18;
    const tuning = ['A', 'E', 'C', 'G']; // Afinação Padrão Ukulele (C-tuning, 1ª para 4ª corda)
    const notesSharp = ['C', 'C#', 'D', 'D#', 'E', 'F', 'F#', 'G', 'G#', 'A', 'A#', 'B'];
    const openStringNotes = [notesSharp.indexOf('A'), notesSharp.indexOf('E'), notesSharp.indexOf('C'), notesSharp.indexOf('G')];
    const connectingEffects = ['h', 'p', '/'];

    // Biblioteca de Acordes de UKULELE
    const chordLibrary = [
        { name: 'C', shape: ['3', '0', '0', '0'] }, { name: 'G', shape: ['2', '3', '2', '0'] },
        { name: 'Am', shape: ['0', '0', '0', '2'] }, { name: 'F', shape: ['0', '1', '0', '2'] },
        { name: 'Dm', shape: ['0', '1', '2', '2'] }, { name: 'E', shape: ['2', '0', '4', '1'] },
        { name: 'Em', shape: ['3', '2', '4', '0'] }, { name: 'D', shape: ['0', '2', '2', '2'] },
        { name: 'G7', shape: ['2', '1', '2', '0'] }, { name: 'C7', shape: ['1', '0', '0', '0'] },
        { name: 'A', shape: ['1', '0', '0', '2'] }, { name: 'B7', shape: ['3', '2', '4', '2'] },
    ];

    // --- Seleção dos Elementos do DOM ---
    const editorContainer = document.getElementById('ukulele-editor');
    const fretNumbersContainerWrapper = document.getElementById('fret-numbers-container-wrapper');
    const tabTexto = document.getElementById('tablatura-texto');
    const btnLimpar = document.getElementById('btn-limpar');
    const btnCopiar = document.getElementById('btn-copiar');
    const btnSalvarMusica = document.getElementById('btn-salvar-musica');
    const btnSepararParte = document.getElementById('btn-separar-parte');
    const btnModoAcorde = document.getElementById('btn-modo-acorde');
    const efeitosContainer = document.getElementById('efeitos-container');
    
    const modalMusicas = document.getElementById('modal-musicas');
    const btnAbrirMusicasSalvas = document.getElementById('btn-abrir-musicas-salvas');
    const btnFecharMusicas = document.getElementById('btn-fechar-musicas');
    const listaMusicasSalvas = document.getElementById('lista-musicas-salvas');

    const modalAcordes = document.getElementById('modal-acordes');
    const btnAbrirAcordes = document.getElementById('btn-abrir-acordes');
    const btnFecharAcordes = document.getElementById('btn-fechar-acordes');
    const listaAcordes = document.getElementById('lista-acordes');

    const escalaSelect = document.getElementById('escala-select');
    const escalaDisplay = document.getElementById('escala-display');

    // --- Variáveis de Estado ---
    let tabLines = [];
    let lastPlayedStringIndex = -1;
    let skipNextSeparator = false;
    let isChordModeActive = false;
    let manualChord = {};

    // --- Funções de Geração da Interface ---
    function createFretboard(container, fretNumContainer, isEditor = false) {
        container.innerHTML = '';
        const fretboard = document.createElement('div');
        fretboard.className = 'fretboard';
        
        if (fretNumContainer) {
            fretNumContainer.innerHTML = '';
            const fretNumbers = document.createElement('div');
            fretNumbers.className = 'fret-numbers';
            for (let j = 0; j <= NUM_FRETS; j++) {
                const fretNumDiv = document.createElement('div');
                if (j > 0) fretNumDiv.textContent = j;
                fretNumbers.appendChild(fretNumDiv);
            }
            fretNumContainer.appendChild(fretNumbers);
        }
        
        for (let i = 0; i < NUM_STRINGS; i++) {
            const stringDiv = document.createElement('div');
            stringDiv.className = 'string';
            for (let j = 0; j <= NUM_FRETS; j++) {
                const fretDiv = document.createElement('div');
                fretDiv.className = 'fret';
                fretDiv.dataset.string = i;
                fretDiv.dataset.fret = j;
                stringDiv.appendChild(fretDiv);
            }
            fretboard.appendChild(stringDiv);
        }
        
        const markerFretsSingle = [5, 7, 10, 15];
        const markerFretsDouble = [12];
        
        const attachMarker = (fretNum, type) => {
            if (fretNum <= NUM_FRETS) {
                const hostFret = fretboard.children[1].children[fretNum]; // Posição para 4 cordas
                hostFret.classList.add('marker-host');
                const markerContainer = document.createElement('div');
                markerContainer.className = 'fret-marker-container';
                const marker = document.createElement('div');
                marker.className = `fret-marker ${type}`;
                if (type === 'single') marker.innerHTML = '●';
                markerContainer.appendChild(marker);
                hostFret.appendChild(markerContainer);
            }
        };
        
        markerFretsSingle.forEach(fretNum => attachMarker(fretNum, 'single'));
        markerFretsDouble.forEach(fretNum => attachMarker(fretNum, 'double'));

        container.appendChild(fretboard);

        if (isEditor) {
            fretboard.addEventListener('click', handleFretClick);
            editorContainer.addEventListener('scroll', () => {
                fretNumbersContainerWrapper.scrollLeft = editorContainer.scrollLeft;
            });
        }
        return fretboard;
    }

    // --- Funções de Tablatura ---
    const initTab = () => {
        if (isChordModeActive) toggleChordMode();
        tabLines = tuning.map(s => s.padEnd(1, ' ') + '|');
        lastPlayedStringIndex = -1;
        skipNextSeparator = true;
        updateTabText();
    };

    const updateTabText = () => {
        let maxLength = 0;
        if (tabLines.length > 0 && tabLines[0].length > 0) {
            maxLength = Math.max(...tabLines.map(line => line.length));
        }
        tabTexto.value = tabLines.map(line => line.padEnd(maxLength, '-')).join('\n');
        tabTexto.scrollTop = tabTexto.scrollHeight;
    };

    const addPartSeparator = () => {
        if (isChordModeActive) toggleChordMode();
        if (tabLines[0].length <= 2) return;
        tabLines = tabLines.map(line => line + '--||');
        skipNextSeparator = true;
        lastPlayedStringIndex = -1;
        updateTabText();
    };
    
    const addSingleNoteToTab = (stringIndex, char) => {
        const charStr = char.toString();
        if (!skipNextSeparator) {
            tabLines = tabLines.map(line => line + '--');
        }
        const maxLength = Math.max(...tabLines.map(line => line.length));
        for (let i = 0; i < NUM_STRINGS; i++) {
            tabLines[i] = tabLines[i].padEnd(maxLength, '-');
            if (i === stringIndex) {
                tabLines[i] += charStr;
            } else {
                tabLines[i] += '-'.repeat(charStr.length);
            }
        }
        skipNextSeparator = false;
        updateTabText();
    };

    const addEffectToTab = (effect) => {
        if (isChordModeActive) return;
        if (lastPlayedStringIndex === -1 && effect !== 'x') return;
        if (tabLines[0].length <= 2) return;

        if (effect === 'x') {
            if (!skipNextSeparator) tabLines = tabLines.map(line => line + '--');
            const maxLength = Math.max(...tabLines.map(line => line.length));
            for (let i = 0; i < NUM_STRINGS; i++) {
                tabLines[i] = tabLines[i].padEnd(maxLength, '-') + 'x';
            }
            skipNextSeparator = false;
            updateTabText();
            return;
        }

        const maxLength = Math.max(...tabLines.map(line => line.length));
        for (let i = 0; i < NUM_STRINGS; i++) {
             tabLines[i] = tabLines[i].padEnd(maxLength, '-');
            if (i === lastPlayedStringIndex) {
                tabLines[i] += effect;
            } else {
                 tabLines[i] += '-'.repeat(effect.length);
            }
        }
        skipNextSeparator = connectingEffects.includes(effect);
        updateTabText();
    };

    const addChordToTab = (chordShape) => {
        if (!skipNextSeparator) {
            tabLines = tabLines.map(line => line + '--');
        }
        const contentMaxLength = Math.max(...chordShape.map(n => n.toString().length));
        const currentTabMaxLength = Math.max(...tabLines.map(line => line.length));
        for (let i = 0; i < NUM_STRINGS; i++) {
            tabLines[i] = tabLines[i].padEnd(currentTabMaxLength, '-');
            const note = chordShape[i].toString();
            const paddedNote = note.padStart(contentMaxLength, '-');
            tabLines[i] += paddedNote;
        }
        skipNextSeparator = false;
        lastPlayedStringIndex = -1;
        updateTabText();
    };

    // --- Lógica do Modo de Acorde Manual ---
    const toggleChordMode = () => {
        isChordModeActive = !isChordModeActive;
        btnModoAcorde.classList.toggle('active-mode', isChordModeActive);
        if (isChordModeActive) {
            btnModoAcorde.textContent = 'Finalizar Acorde';
            manualChord = {};
        } else {
            btnModoAcorde.textContent = 'Acorde Manual';
            if (Object.keys(manualChord).length > 0) {
                const shape = Array(NUM_STRINGS).fill('x');
                for (const stringIdx in manualChord) {
                    shape[stringIdx] = manualChord[stringIdx];
                }
                addChordToTab(shape);
            }
            clearChordHighlights();
            manualChord = {};
        }
    };
    
    const handleChordBuildingClick = (fretElement) => {
        const stringIndex = parseInt(fretElement.dataset.string);
        const fretNumber = parseInt(fretElement.dataset.fret);
        if (manualChord[stringIndex] === fretNumber) {
            delete manualChord[stringIndex];
            fretElement.classList.remove('fret-selecionado');
            return;
        }
        if (manualChord[stringIndex] !== undefined) {
            const oldFret = manualChord[stringIndex];
            const oldFretEl = editorContainer.querySelector(`.fret[data-string='${stringIndex}'][data-fret='${oldFret}']`);
            if(oldFretEl) oldFretEl.classList.remove('fret-selecionado');
        }
        manualChord[stringIndex] = fretNumber;
        fretElement.classList.add('fret-selecionado');
    };

    const clearChordHighlights = () => {
        editorContainer.querySelectorAll('.fret-selecionado').forEach(el => el.classList.remove('fret-selecionado'));
    };

    // --- Dispatcher de Eventos de Clique ---
    function handleFretClick(event) {
        const fret = event.target.closest('.fret');
        if (!fret) return;
        if (isChordModeActive) {
            handleChordBuildingClick(fret);
        } else {
            const stringIndex = parseInt(fret.dataset.string);
            const fretNumber = parseInt(fret.dataset.fret);
            lastPlayedStringIndex = stringIndex;
            addSingleNoteToTab(stringIndex, fretNumber);
        }
    }

    // --- Lógica dos Botões e Modais ---
    efeitosContainer.addEventListener('click', (event) => {
        const button = event.target.closest('.btn-efeito');
        if (button && button.dataset.efeito) addEffectToTab(button.dataset.efeito);
    });
    btnSepararParte.addEventListener('click', addPartSeparator);
    btnLimpar.addEventListener('click', initTab);
    btnModoAcorde.addEventListener('click', toggleChordMode);
    btnCopiar.addEventListener('click', () => {
        if (!tabTexto.value) return;
        navigator.clipboard.writeText(tabTexto.value).then(() => {
            const originalText = btnCopiar.textContent;
            btnCopiar.textContent = 'Copiado!';
            setTimeout(() => { btnCopiar.textContent = originalText; }, 1500);
        });
    });
    
    btnSalvarMusica.addEventListener('click', () => {
        const tab = tabTexto.value;
        if (tab.replace(/[AECG|]/g, '').replace(/-/g, '').trim() === '') {
             alert('A tablatura está vazia!'); return;
        }
        const nomeMusica = prompt('Digite um nome para a sua música:');
        if (!nomeMusica || nomeMusica.trim() === '') {
             alert('Nome inválido. A música não foi salva.'); return;
        }
        const musicas = JSON.parse(localStorage.getItem('minhasMusicasUkulele')) || [];
        musicas.push({ nome: nomeMusica.trim(), tab: tab });
        localStorage.setItem('minhasMusicasUkulele', JSON.stringify(musicas));
        alert(`Música "${nomeMusica}" salva com sucesso!`);
        initTab();
    });

    btnAbrirMusicasSalvas.addEventListener('click', () => { renderizarMusicasSalvas(); modalMusicas.classList.add('visivel'); });
    btnFecharMusicas.addEventListener('click', () => modalMusicas.classList.remove('visivel'));
    modalMusicas.addEventListener('click', (event) => { if (event.target === modalMusicas) modalMusicas.classList.remove('visivel'); });

    btnAbrirAcordes.addEventListener('click', () => { renderizarBibliotecaAcordes(); modalAcordes.classList.add('visivel'); });
    btnFecharAcordes.addEventListener('click', () => modalAcordes.classList.remove('visivel'));
    modalAcordes.addEventListener('click', (event) => { if (event.target === modalAcordes) modalAcordes.classList.remove('visivel'); });
    
    function renderizarMusicasSalvas() {
        listaMusicasSalvas.innerHTML = '';
        const musicas = JSON.parse(localStorage.getItem('minhasMusicasUkulele')) || [];
        if (musicas.length === 0) {
            listaMusicasSalvas.innerHTML = '<p>Nenhuma música salva ainda.</p>';
            return;
        }
        musicas.forEach((musica, index) => {
            const musicaItem = document.createElement('div');
            musicaItem.className = 'musica-item';
            const safeName = musica.nome.replace(/</g, "&lt;").replace(/>/g, "&gt;");
            const safeTab = musica.tab.replace(/</g, "&lt;").replace(/>/g, "&gt;");
            musicaItem.innerHTML = `<div class="musica-header"><h3>${safeName}</h3><button class="btn-excluir-musica" data-index="${index}">&times;</button></div><pre class="tab-salva">${safeTab}</pre>`;
            listaMusicasSalvas.appendChild(musicaItem);
        });
    }
    
    listaMusicasSalvas.addEventListener('click', (event) => {
        if (event.target.classList.contains('btn-excluir-musica')) {
            if (confirm('Tem a certeza que deseja excluir esta música?')) {
                const index = event.target.dataset.index;
                let musicas = JSON.parse(localStorage.getItem('minhasMusicasUkulele')) || [];
                musicas.splice(index, 1);
                localStorage.setItem('minhasMusicasUkulele', JSON.stringify(musicas));
                renderizarMusicasSalvas();
            }
        }
    });

    function renderizarBibliotecaAcordes() {
        if (listaAcordes.children.length > 0) return;
        chordLibrary.forEach((chord, index) => {
            const acordeItem = document.createElement('div');
            acordeItem.className = 'acorde-item';
            acordeItem.dataset.chordIndex = index;
            let tabDiagram = '';
            for(let i = 0; i < tuning.length; i++) {
                tabDiagram += `${tuning[i]}|-${chord.shape[i].padStart(1, '-')}-|\n`;
            }
            acordeItem.innerHTML = `<h4>${chord.name}</h4><pre>${tabDiagram.trim()}</pre>`;
            listaAcordes.appendChild(acordeItem);
        });
    }

    listaAcordes.addEventListener('click', (event) => {
        const chordItem = event.target.closest('.acorde-item');
        if (chordItem) {
            const chordIndex = parseInt(chordItem.dataset.chordIndex);
            addChordToTab(chordLibrary[chordIndex].shape);
            modalAcordes.classList.remove('visivel');
        }
    });

    // --- Geração do Guia de Escalas ---
    function getNoteName(noteIndex) { return notesSharp[noteIndex % 12]; }
    function getPentatonicMajor(rootNote) {
        const rootIndex = notesSharp.indexOf(rootNote);
        return [ rootIndex % 12, (rootIndex + 2) % 12, (rootIndex + 4) % 12, (rootIndex + 7) % 12, (rootIndex + 9) % 12 ];
    }
    
    function populateScaleSelector() {
        const scaleOrder = ['E', 'F', 'F#', 'G', 'G#', 'A', 'A#', 'B', 'C', 'C#', 'D', 'D#'];
        scaleOrder.forEach(rootNote => {
            const rootIndex = notesSharp.indexOf(rootNote);
            const relativeMinorIndex = (rootIndex + 9) % 12;
            const option = document.createElement('option');
            option.value = rootNote;
            option.textContent = `${getNoteName(rootIndex)} Maior / ${getNoteName(relativeMinorIndex)} Menor`;
            escalaSelect.appendChild(option);
        });
    }

    function displaySelectedScale(rootNote) {
        escalaDisplay.innerHTML = '';
        const scaleNotes = getPentatonicMajor(rootNote);
        const rootIndex = scaleNotes[0];
        const title = document.createElement('h3');
        title.innerHTML = `Visualização da Escala de ${getNoteName(rootIndex)} Maior Pentatônica`;
        const fretboardContainer = document.createElement('div');
        fretboardContainer.className = 'fretboard-container';
        const fretboard = createFretboard(fretboardContainer, null, false);
        for (let i = 0; i < NUM_STRINGS; i++) {
            for (let j = 0; j <= NUM_FRETS; j++) {
                const currentNoteIndex = (openStringNotes[i] + j) % 12;
                const noteDot = document.createElement('div');
                noteDot.className = 'nota-ponto';
                noteDot.textContent = getNoteName(currentNoteIndex);
                if (scaleNotes.includes(currentNoteIndex)) {
                    noteDot.classList.add('escala');
                    if (currentNoteIndex === rootIndex) noteDot.classList.add('tonica');
                } else {
                    noteDot.classList.add('outra');
                }
                fretboard.children[i].children[j].appendChild(noteDot);
            }
        }
        escalaDisplay.appendChild(title);
        escalaDisplay.appendChild(fretboardContainer);
    }

    // --- Inicialização ---
    createFretboard(editorContainer, fretNumbersContainerWrapper, true);
    initTab();
    populateScaleSelector();
    escalaSelect.addEventListener('change', (e) => displaySelectedScale(e.target.value));
    if (escalaSelect.options.length > 0) displaySelectedScale(escalaSelect.value);
});
</script>

</body>
</html>